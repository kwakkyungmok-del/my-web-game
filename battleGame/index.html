<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì „íˆ¬ ê²Œì„</title>
<style>
body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial, sans-serif; }
h1 { text-align:center; padding:20px 0; }
.container { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; padding:20px; }
.card { background:#1c1c1c; border-radius:12px; padding:20px; cursor:pointer; transition:0.2s; }
.card:hover { transform:scale(1.05); background:#2a2a2a; }
input, select, button { margin:5px 0; padding:6px 10px; border-radius:6px; border:none; }
button { cursor:pointer; background:#6366f1; color:#fff; transition:0.2s; }
button:hover { background:#4f46e5; }
#battleModal, #charModal, #leaderboardModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
#battleModal div, #charModal div, #leaderboardModal div { background:#1a1a1a; padding:20px; border-radius:12px; width:320px; max-width:90%; text-align:left; max-height:80%; overflow-y:auto; }
#charList { background:#222; padding:10px; border-radius:8px; max-height:150px; overflow-y:auto; margin-top:10px; }
@media(max-width:768px){
  .container { grid-template-columns:1fr !important; padding:10px !important; }
  .card { padding:15px !important; font-size:14px !important; }
}
</style>
</head>
<body>

<h1>âš”ï¸ ì „íˆ¬ ê²Œì„</h1>

<div class="container">

  <div class="card">
    <h2>ìºë¦­í„° ì„ íƒ / ìƒì„±</h2>
    <label>ìºë¦­í„° ì´ë¦„: <input type="text" id="charName" placeholder="ìºë¦­í„° ì´ë¦„"></label><br>
    <label>ì§ì—… ì„ íƒ:
      <select id="jobSelect">
        <option value="warrior">ì „ì‚¬</option>
        <option value="mage">ë§ˆë²•ì‚¬</option>
        <option value="archer">ê¶ìˆ˜</option>
        <option value="rogue">ë„ì </option>
        <option value="paladin">ì„±ê¸°ì‚¬</option>
      </select>
    </label><br>
    <label>ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸: <input type="text" id="weaponPassword" placeholder="ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸"></label><br>
    <button id="loadCharBtn">ìºë¦­í„° ìƒì„± / ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <h3>ìºë¦­í„° ëª©ë¡</h3>
    <div id="charList"></div>
  </div>

  <div class="card">
    <h2>ë°°í‹€ ì‹œì‘</h2>
    <label>í”Œë ˆì´ì–´2 ìºë¦­í„°:
      <select id="player2Select"></select>
    </label><br>
    <button id="startBattleBtn">ë°°í‹€!</button>
  </div>

  <div class="card">
    <h2>ë¦¬ë”ë³´ë“œ</h2>
    <button id="showLeaderboardBtn">ğŸ† ìˆœìœ„ ë³´ê¸°</button>
  </div>

</div>

<!-- ë°°í‹€ ëª¨ë‹¬ -->
<div id="battleModal">
  <div>
    <h3>âš¡ ë°°í‹€ ê²°ê³¼</h3>
    <div id="battleText" style="line-height:1.4;"></div>
    <button id="closeBattleBtn">ë‹«ê¸°</button>
  </div>
</div>

<!-- ë¦¬ë”ë³´ë“œ ëª¨ë‹¬ -->
<div id="leaderboardModal">
  <div>
    <h3>ğŸ† ë¦¬ë”ë³´ë“œ</h3>
    <div id="leaderboardList" style="margin:10px 0;"></div>
    <button id="closeLeaderboardBtn">ë‹«ê¸°</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentChar = null;

// ìºë¦­í„° ëª©ë¡ ë¡œë“œ
async function loadCharacterList(){
  const { data, error } = await sb.from('characters').select('id,name').order('created_at',{ascending:true});
  if(error){ console.log(error); return; }
  const listDiv = document.getElementById('charList');
  const select = document.getElementById('player2Select');
  listDiv.innerHTML = '';
  select.innerHTML = '';
  data.forEach(char=>{
    listDiv.innerHTML += `<div>${char.name} (ID: ${char.id})</div>`;
    if(currentChar && char.id !== currentChar.id){
      select.innerHTML += `<option value="${char.id}">${char.name}</option>`;
    }
  });
}

// ìºë¦­í„° ìƒì„± / ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('loadCharBtn').onclick = async () => {
  const name = document.getElementById('charName').value.trim();
  const job = document.getElementById('jobSelect').value;
  const pwd = document.getElementById('weaponPassword').value.trim();
  if(!name || !pwd){ alert("ì´ë¦„ê³¼ ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"); return; }

  try{
    const { data: weapon, error: wErr } = await sb.from('weapons').select('id,name,level').eq('password',pwd).limit(1).single();
    if(wErr || !weapon){ alert("ë¬´ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    const jobStats = {
      warrior:{base_atk:5, base_def:3}, mage:{base_atk:7, base_def:1},
      archer:{base_atk:6, base_def:2}, rogue:{base_atk:4, base_def:3}, paladin:{base_atk:5, base_def:4}
    };
    const stats = jobStats[job];

    const { data: charData, error: cErr } = await sb.from('characters').insert([{
      owner:'player', name, base_atk: stats.base_atk, base_def: stats.base_def, weapon_id: weapon.id
    }]).select().single();
    if(cErr) throw cErr;

    currentChar = charData;
    alert(`${name} ìºë¦­í„° ìƒì„± ì™„ë£Œ! ë¬´ê¸°: ${weapon.name} Lv.${weapon.level}`);
    loadCharacterList();
  }catch(e){ alert("ì‹¤íŒ¨: "+e.message); }
};

// ë°°í‹€ ì‹œì‘
document.getElementById('startBattleBtn').onclick = async () => {
  if(!currentChar){ alert("ë¨¼ì € ìºë¦­í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”."); return; }
  const p1 = currentChar.id;
  const p2 = document.getElementById('player2Select').value;
  if(!p2){ alert("í”Œë ˆì´ì–´2ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }

  try{
    const { data: chars } = await sb.from('characters').select('id,name,base_atk,base_def,weapon_id(level,name)').in('id',[p1,p2]);
    const [c1,c2] = chars[0].id===p1?[chars[0],chars[1]]:[chars[1],chars[0]];

    const atk1 = c1.base_atk + c1.weapon_id.level;
    const atk2 = c2.base_atk + c2.weapon_id.level;
    const final1 = atk1 - c2.base_def;
    const final2 = atk2 - c1.base_def;

    let winner=null, loser=null;
    if(final1>final2){ winner=c1; loser=c2; }
    else if(final2>final1){ winner=c2; loser=c1; }

    const winTexts=["ê°€ë³ê²Œ ê³µê²©ì„ ì„±ê³µí–ˆë‹¤!","ì¹˜ëª…íƒ€ë¥¼ ë‚ ë ¸ë‹¤!","ê°•ë ¥í•œ ë§ˆë²•ìœ¼ë¡œ ìŠ¹ë¦¬!","ì™„ë²½í•œ ì „ëµìœ¼ë¡œ ìƒëŒ€ë¥¼ ì œì••!"];
    const loseTexts=["ë°©ì–´ì— ì‹¤íŒ¨í–ˆë‹¤!","ê³µê²©ì„ íšŒí”¼ë‹¹í–ˆë‹¤!","ë§ˆë²• ë°©ì–´ì— ê±¸ë ¸ë‹¤!","ì „ëµì´ ë¹—ë‚˜ê°”ë‹¤!"];
    let msg="";
    if(winner){ msg=`${winner.name} ìŠ¹ë¦¬!\n${winTexts[Math.floor(Math.random()*winTexts.length)]}\n${loser.name} íŒ¨ë°°.\n${loseTexts[Math.floor(Math.random()*loseTexts.length)]}`; }
    else{ msg="ë¹„ê²¼ìŠµë‹ˆë‹¤!"; }

    document.getElementById('battleText').innerText = msg;
    document.getElementById('battleModal').style.display='flex';

    await sb.from('battles').insert([{player1_id:p1, player2_id:p2, winner_id: winner ? winner.id:null}]);
    if(winner){
      const { data: lb } = await sb.from('leaderboard').select('id,wins').eq('player_id',winner.id).single();
      if(!lb) await sb.from('leaderboard').insert([{player_id:winner.id,wins:1}]);
      else await sb.from('leaderboard').update({wins:lb.wins+1}).eq('id',lb.id);
    }
  }catch(e){ alert("ë°°í‹€ ì‹¤íŒ¨: "+e.message); }
};

document.getElementById('closeBattleBtn').onclick = ()=>{ document.getElementById('battleModal').style.display='none'; };

// ë¦¬ë”ë³´ë“œ
document.getElementById('showLeaderboardBtn').onclick = async ()=>{
  try{
    const { data } = await sb.from('leaderboard').select('player_id,wins,characters(name)').order('wins',{ascending:false});
    const div = document.getElementById('leaderboardList');
    div.innerHTML = "";
    data.forEach((row,idx)=>{
      div.innerHTML += `${idx+1}. ${row.characters.name} - ${row.wins}ìŠ¹<br>`;
    });
    document.getElementById('leaderboardModal').style.display='flex';
  }catch(e){ alert("ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: "+e.message); }
};
document.getElementById('closeLeaderboardBtn').onclick = ()=>{ document.getElementById('leaderboardModal').style.display='none'; };

// ì´ˆê¸° ìºë¦­í„° ëª©ë¡ ë¡œë“œ
loadCharacterList();
</script>
</body>
</html>

