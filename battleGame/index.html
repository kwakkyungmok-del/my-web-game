<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì „íˆ¬ ê²Œì„</title>
<style>
body { background:#111; color:#fff; font-family:Arial,sans-serif; padding:20px; }
h1 { text-align:center; }
button { padding:8px 12px; border:none; border-radius:5px; cursor:pointer; margin:5px; }
#backBtn { background:#0a84ff; color:#fff; }
#backBtn:hover { background:#006be6; }
.card, #createCharDiv { background:#1c1c1c; padding:15px; border-radius:12px; margin:10px 0; }
input, select { padding:5px; border-radius:5px; border:none; margin-right:5px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
.modal div { background:#1a1a1a; padding:20px; border-radius:12px; width:320px; max-width:90%; text-align:left; }
</style>
</head>
<body>

<h1>âš”ï¸ ì „íˆ¬ ê²Œì„</h1>
<button id="backBtn">ğŸ”™ ëŒì•„ê°€ê¸°</button>

<div id="createCharDiv" class="card">
<h3>ìºë¦­í„° ìƒì„±</h3>
<input type="text" id="charName" placeholder="ìºë¦­í„° ì´ë¦„">
<select id="jobSelect">
  <option value="Warrior">Warrior</option>
  <option value="Mage">Mage</option>
  <option value="Archer">Archer</option>
  <option value="Rogue">Rogue</option>
  <option value="Paladin">Paladin</option>
</select>
<input type="text" id="weaponPwd" placeholder="ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸">
<button id="createCharBtn">ìƒì„±</button>
</div>

<div class="card">
<h3>ìºë¦­í„° ëª©ë¡</h3>
<select id="charList"></select>
</div>

<div class="card">
<h3>ì „íˆ¬</h3>
<select id="player1Select"></select>
<select id="player2Select"></select>
<button id="battleBtn">ì „íˆ¬ ì‹œì‘</button>
</div>

<div class="card">
<h3>ğŸ† ë¦¬ë”ë³´ë“œ</h3>
<button id="loadLeaderboardBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
<div id="leaderboardList"></div>
</div>

<div id="battleModal" class="modal">
  <div>
    <h3>ì „íˆ¬ ê²°ê³¼</h3>
    <div id="battleText"></div>
    <button id="closeBattleModal">ë‹«ê¸°</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// ëŒì•„ê°€ê¸°
document.getElementById('backBtn').onclick = ()=>{ location.href='https://kwakkyungmok-del.github.io/my-web-game/'; };

// ìºë¦­í„° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
async function refreshCharList(){
  const { data, error } = await sb.from('characters').select('id,name').order('created_at',{ascending:true});
  if(error){ alert("ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:"+error.message); return; }
  const charList = document.getElementById('charList');
  const player1Select = document.getElementById('player1Select');
  const player2Select = document.getElementById('player2Select');
  charList.innerHTML=''; player1Select.innerHTML=''; player2Select.innerHTML='';
  data.forEach(c=>{
    const opt = new Option(c.name,c.id);
    charList.add(opt);
    player1Select.add(new Option(c.name,c.id));
    if(c.id!==player1Select.value) player2Select.add(new Option(c.name,c.id));
  });
}

// ìºë¦­í„° ìƒì„±
document.getElementById('createCharBtn').onclick = async ()=>{
  const name = document.getElementById('charName').value.trim();
  const job = document.getElementById('jobSelect').value;
  const pwd = document.getElementById('weaponPwd').value.trim();
  if(!name||!pwd){ alert("ì´ë¦„ê³¼ ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ìˆ˜"); return; }

  // ë¬´ê¸° ì°¾ê¸°
  const { data:weaponData, error:wpErr } = await sb.from('weapons').select('id,name,level').eq('password',pwd);
  if(wpErr || !weaponData || weaponData.length===0){ alert("ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ"); return; }
  const weapon = weaponData[0];

  // ì§ì—…ë³„ base_defì™€ ê³µê²©ë ¥ ì¶”ê°€ê°’
  const jobStats = {Warrior:{atk:2,def:3},Mage:{atk:4,def:1},Archer:{atk:3,def:2},Rogue:{atk:3,def:1},Paladin:{atk:2,def:4}};
  const base_atk = weapon.level + jobStats[job].atk;
  const base_def = jobStats[job].def;

  // ìºë¦­í„° ìƒì„±
  const { data, error } = await sb.from('characters').insert([{owner:'me',name,base_atk,base_def,weapon_id:weapon.id}]);
  if(error){ alert("ìºë¦­í„° ìƒì„± ì‹¤íŒ¨:"+error.message); return; }
  alert("ìºë¦­í„° ìƒì„± ì„±ê³µ!");
  refreshCharList();
};

// ë°°í‹€
document.getElementById('battleBtn').onclick = async ()=>{
  const p1id = document.getElementById('player1Select').value;
  const p2id = document.getElementById('player2Select').value;
  if(p1id===p2id){ alert("í”Œë ˆì´ì–´ 2ë¥¼ ë‹¤ë¥¸ ìºë¦­í„°ë¡œ ì„ íƒ"); return; }

  // ìºë¦­í„° ì •ë³´
  const { data:chars, error:cErr } = await sb.from('characters').select('id,name,base_atk,base_def,weapon_id').in('id',[p1id,p2id]);
  if(cErr||chars.length!==2){ alert("ìºë¦­í„° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }

  const [p1,p2] = chars[0].id===p1id?[chars[0],chars[1]]:[chars[1],chars[0]];

  // ë¬´ê¸° ë ˆë²¨ ë¶ˆëŸ¬ì˜¤ê¸°
  const { data:weaponsData } = await sb.from('weapons').select('level').in('id',[p1.weapon_id,p2.weapon_id]);
  if(!weaponsData || weaponsData.length!==2){ alert("ë¬´ê¸° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }

  const p1Atk = p1.base_atk; // ì´ë¯¸ base_atkì— weapon.level í¬í•¨
  const p2Atk = p2.base_atk;
  const p1Def = p1.base_def;
  const p2Def = p2.base_def;

  const p1Total = p1Atk - p2Def;
  const p2Total = p2Atk - p1Def;

  let winner = null;
  if(p1Total>p2Total) winner = p1.id;
  else if(p2Total>p1Total) winner = p2.id;

  // ëœë¤ ì „íˆ¬ ë‚´ìš©
  const events = ["ë©‹ì§„ ê³µê²©!","íšŒí”¼ ì„±ê³µ!","ì¹˜ëª…íƒ€ ë°œìƒ!","ë°©ì–´ ê°•í™”!","ì—°ì† ê³µê²©!"];
  const battleLog = `âš”ï¸ ${p1.name} vs ${p2.name}\n${events[Math.floor(Math.random()*events.length)]} ìŠ¹ë¦¬ìëŠ”: ${winner===p1.id?p1.name:winner===p2.id?p2.name:"ë¬´ìŠ¹ë¶€"}`;
  document.getElementById('battleText').innerText = battleLog;
  document.getElementById('battleModal').style.display='flex';

  // battles í…Œì´ë¸” ê¸°ë¡
  await sb.from('battles').insert([{player1_id:p1.id,player2_id:p2.id,winner_id:winner}]);

  // leaderboard ì—…ë°ì´íŠ¸
  if(winner){
    const { data:lbData } = await sb.from('leaderboard').select('id,wins').eq('character_id',winner);
    if(lbData && lbData.length>0){
      await sb.from('leaderboard').update({wins:lbData[0].wins+1}).eq('id',lbData[0].id);
    }else{
      await sb.from('leaderboard').insert([{character_id:winner,wins:1}]);
    }
  }
};

// ë°°í‹€ ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('closeBattleModal').onclick = ()=>{ document.getElementById('battleModal').style.display='none'; };

// ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('loadLeaderboardBtn').onclick = async ()=>{
  const { data, error } = await sb.from('leaderboard').select('character_id,wins,characters(name)').order('wins',{ascending:false});
  if(error){ alert("ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:"+error.message); return; }
  const lbDiv = document.getElementById('leaderboardList');
  lbDiv.innerHTML='';
  data.forEach(d=>{
    lbDiv.innerHTML+=`${d.characters.name} - ìŠ¹ë¦¬ìˆ˜: ${d.wins}<br>`;
  });
};

// ì´ˆê¸° ë¡œë”©
refreshCharList();
</script>
</body>
</html>
