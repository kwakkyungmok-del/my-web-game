<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì „íˆ¬ ê²Œì„</title>
<style>
body { margin:0; background:#111; color:#fff; font-family:Arial, sans-serif; }
h1 { text-align:center; padding:20px 0; }
.container { display:flex; flex-direction:column; align-items:center; gap:15px; }
.card { background:#1c1c1c; padding:20px; border-radius:12px; cursor:pointer; transition:0.2s; width:320px; }
.card:hover { transform:scale(1.05); background:#2a2a2a; }
button { padding:10px 15px; font-size:16px; border:none; border-radius:5px; cursor:pointer; margin-top:10px; }
#backBtn { background:#0a84ff; color:#fff; }
#backBtn:hover { background:#006be6; }

.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
.modalBox { background:#1a1a1a; padding:20px; border-radius:12px; width:320px; max-height:80%; overflow-y:auto; text-align:center; }
</style>
</head>
<body>

<h1>âš”ï¸ ì „íˆ¬ ê²Œì„</h1>

<div class="container">
  <div class="card">
    <h2>ìºë¦­í„° ìƒì„± / ë¬´ê¸° ë¶ˆëŸ¬ì˜¤ê¸°</h2>
    <input id="charName" placeholder="ìºë¦­í„° ì´ë¦„" style="width:90%; margin-bottom:5px;"><br>
    <input id="weaponPass" placeholder="ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸" style="width:90%; margin-bottom:5px;"><br>
    <select id="jobSelect">
      <option value="warrior">ì „ì‚¬</option>
      <option value="mage">ë§ˆë²•ì‚¬</option>
      <option value="archer">ê¶ìˆ˜</option>
      <option value="rogue">ë„ì </option>
      <option value="paladin">ì„±ê¸°ì‚¬</option>
    </select><br>
    <button id="createCharBtn">ìºë¦­í„° ìƒì„±</button>
  </div>

  <div class="card">
    <h2>ìºë¦­í„° ëª©ë¡</h2>
    <select id="charList" style="width:100%;"></select>
  </div>

  <div class="card">
    <h2>ì „íˆ¬</h2>
    <select id="opponentList" style="width:100%;"></select>
    <button id="fightBtn">ì „íˆ¬ ì‹œì‘</button>
  </div>

  <div class="card">
    <h2>ğŸ† ë¦¬ë”ë³´ë“œ</h2>
    <div id="leaderboardList" style="text-align:left; margin-top:10px;"></div>
    <button id="refreshLB">ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <button id="backBtn">ğŸ”™ ëŒì•„ê°€ê¸°</button>
</div>

<div class="modal" id="battleModal">
  <div class="modalBox">
    <div id="battleText"></div>
    <button id="closeBattle">ë‹«ê¸°</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const charList = document.getElementById('charList');
const opponentList = document.getElementById('opponentList');
const leaderboardList = document.getElementById('leaderboardList');
const battleModal = document.getElementById('battleModal');
const battleText = document.getElementById('battleText');

const JOBS = {
  warrior: {base_atk:5, base_def:3},
  mage: {base_atk:7, base_def:1},
  archer: {base_atk:6, base_def:2},
  rogue: {base_atk:6, base_def:2},
  paladin: {base_atk:4, base_def:4}
};

async function loadCharacters(){
  const { data, error } = await sb.from('characters').select('id,name');
  if(error){ console.error(error); return; }
  charList.innerHTML = '';
  opponentList.innerHTML = '';
  data.forEach(c=>{
    const opt1 = document.createElement('option'); opt1.value=c.id; opt1.text=c.name; charList.add(opt1);
    const opt2 = document.createElement('option'); opt2.value=c.id; opt2.text=c.name; opponentList.add(opt2);
  });
}
loadCharacters();

document.getElementById('createCharBtn').onclick = async ()=>{
  const name = document.getElementById('charName').value.trim();
  const job = document.getElementById('jobSelect').value;
  const weaponPass = document.getElementById('weaponPass').value.trim();
  if(!name || !weaponPass){ alert('ì´ë¦„ê³¼ ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }

  const { data:weaponData, error:wpErr } = await sb.from('weapons').select('id,name,level').eq('password',weaponPass).maybeSingle();
  if(wpErr || !weaponData){ alert('ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤'); return; }

  const baseAtk = JOBS[job].base_atk + weaponData.level;
  const { data, error } = await sb.from('characters').insert([{
    name:name, base_atk:baseAtk, base_def:JOBS[job].base_def, weapon_id:weaponData.id
  }]);
  if(error){ alert('ìºë¦­í„° ìƒì„± ì‹¤íŒ¨'); return; }
  await loadCharacters();
  alert('ìºë¦­í„° ìƒì„± ì™„ë£Œ!');
};

document.getElementById('fightBtn').onclick = async () => {
    const player1Id = charList.value;
    if(!player1Id){ 
        alert('í”Œë ˆì´ì–´ ì„ íƒ í•„ìš”'); 
        return; 
    }

    // ëª¨ë“  ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸°
    const { data: charsData, error } = await sb.from('characters').select('*');
    if(error || !charsData || charsData.length < 2){ 
        alert('ìºë¦­í„° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ë˜ëŠ” ì¶©ë¶„í•˜ì§€ ì•ŠìŒ'); 
        return; 
    }

    // í”Œë ˆì´ì–´1
    const p1 = charsData.find(c => c.id === player1Id);

    // í”Œë ˆì´ì–´2 ëœë¤ ì„ íƒ (í”Œë ˆì´ì–´1 ì œì™¸)
    const opponents = charsData.filter(c => c.id !== player1Id);
    const p2 = opponents[Math.floor(Math.random() * opponents.length)];

    // ì „íˆ¬ ì¿¨íƒ€ì„ ì²´í¬ (30ì´ˆ)
    const now = new Date();
    const cooldownSec = 30;
    const p1Last = p1.last_fight ? new Date(p1.last_fight) : new Date(0);
    const p2Last = p2.last_fight ? new Date(p2.last_fight) : new Date(0);

    if((now - p1Last)/1000 < cooldownSec){ 
        alert(`${p1.name}ì€(ëŠ”) ì•„ì§ ì „íˆ¬ ì¿¨íƒ€ì„ì…ë‹ˆë‹¤. ${Math.ceil(cooldownSec - (now - p1Last)/1000)}ì´ˆ ë‚¨ìŒ`);
        return;
    }
    if((now - p2Last)/1000 < cooldownSec){ 
        alert(`${p2.name}ì€(ëŠ”) ì•„ì§ ì „íˆ¬ ì¿¨íƒ€ì„ì…ë‹ˆë‹¤. ${Math.ceil(cooldownSec - (now - p2Last)/1000)}ì´ˆ ë‚¨ìŒ`);
        return;
    }

    // ì „íˆ¬ ê³„ì‚°
    const score1 = p1.base_atk - p2.base_def;
    const score2 = p2.base_atk - p1.base_def;
    const winnerId = score1 >= score2 ? p1.id : p2.id;
    const winnerChar = [p1, p2].find(c => c.id === winnerId);

    // ì „íˆ¬ ê²°ê³¼ í‘œì‹œ
    battleText.innerHTML = `${p1.name} vs ${p2.name} â†’ ìŠ¹ë¦¬: ${winnerChar.name}`;
    battleModal.style.display = 'flex';

    // battles ê¸°ë¡
    await sb.from('battles').insert([{player1_id: p1.id, player2_id: p2.id, winner_id: winnerId}]);

    // ìºë¦­í„° last_fight ì—…ë°ì´íŠ¸
    await sb.from('characters').update({last_fight: now.toISOString()}).in('id', [p1.id, p2.id]);

    // leaderboard ì—…ë°ì´íŠ¸ (ì´ë¦„ í¬í•¨)
    const { data: lbData } = await sb.from('leaderboard').select('id,wins').eq('character_id', winnerId);
    if(lbData && lbData.length > 0){
        await sb.from('leaderboard').update({wins: lbData[0].wins + 1, name: winnerChar.name}).eq('id', lbData[0].id);
    } else {
        await sb.from('leaderboard').insert([{character_id: winnerId, wins: 1, name: winnerChar.name}]);
    }

    // ë¦¬ë”ë³´ë“œ ìƒˆë¡œê³ ì¹¨
    refreshLeaderboard();
};

</script>

</body>
</html>
