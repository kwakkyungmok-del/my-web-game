<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>전투 게임</title>
<style>
body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial, sans-serif; }
h1 { text-align:center; padding:20px 0; }
.container { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; padding:20px; }

.card { background:#1c1c1c; border-radius:12px; padding:20px; cursor:pointer; transition:0.2s; }
.card:hover { transform:scale(1.05); background:#2a2a2a; }

input, select, button { margin:5px 0; padding:6px 10px; border-radius:6px; border:none; }
button { cursor:pointer; background:#6366f1; color:#fff; transition:0.2s; }
button:hover { background:#4f46e5; }

#battleModal, #charModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
#battleModal div, #charModal div { background:#1a1a1a; padding:20px; border-radius:12px; width:320px; max-width:90%; text-align:left; max-height:80%; overflow-y:auto; }

#charList { background:#222; padding:10px; border-radius:8px; max-height:150px; overflow-y:auto; margin-top:10px; }

@media(max-width:768px){
  .container { grid-template-columns:1fr !important; padding:10px !important; }
  .card { padding:15px !important; font-size:14px !important; }
}
</style>
</head>
<body>

<h1>⚔️ 전투 게임</h1>

<div class="container">

  <div class="card">
    <h2>캐릭터 선택 / 생성</h2>
    <label>캐릭터 이름: <input type="text" id="charName" placeholder="캐릭터 이름"></label><br>
    <label>직업 선택:
      <select id="jobSelect">
        <option value="warrior">전사</option>
        <option value="mage">마법사</option>
        <option value="archer">궁수</option>
        <option value="rogue">도적</option>
        <option value="paladin">성기사</option>
      </select>
    </label><br>
    <label>무기 비밀번호: <input type="text" id="weaponPassword" placeholder="무기 비밀번호"></label><br>
    <button id="loadCharBtn">캐릭터 불러오기</button>

    <h3>현재 캐릭터 목록</h3>
    <div id="charList"></div>
  </div>

  <div class="card">
    <h2>배틀 시작</h2>
    <label>플레이어1 캐릭터 ID: <input type="text" id="player1Id"></label><br>
    <label>플레이어2 캐릭터 ID: <input type="text" id="player2Id"></label><br>
    <button id="startBattleBtn">배틀!</button>
  </div>

</div>

<!-- 모달 -->
<div id="battleModal">
  <div>
    <h3>⚡ 배틀 결과</h3>
    <div id="battleText" style="line-height:1.4;"></div>
    <button id="closeBattleBtn">닫기</button>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// 캐릭터 목록 표시
async function loadCharacterList(){
  try{
    const { data, error } = await sb.from('characters').select('id,name').order('created_at',{ascending:true});
    if(error) throw error;
    const listDiv = document.getElementById('charList');
    listDiv.innerHTML = '';
    data.forEach(char=>{
      const div = document.createElement('div');
      div.textContent = `${char.name} (ID: ${char.id})`;
      listDiv.appendChild(div);
    });
  }catch(e){
    console.log("캐릭터 목록 불러오기 실패:", e.message);
  }
}
loadCharacterList();

// 캐릭터 불러오기
document.getElementById('loadCharBtn').onclick = async () => {
  const name = document.getElementById('charName').value.trim();
  const job = document.getElementById('jobSelect').value;
  const pwd = document.getElementById('weaponPassword').value.trim();

  if(!name || !pwd){
    alert("이름과 무기 비밀번호를 입력하세요.");
    return;
  }

  try{
    // 무기 확인
    const { data: weaponData, error: weaponErr } = await sb.from('weapons')
      .select('id,name,level')
      .eq('password', pwd)
      .limit(1)
      .single();
    if(weaponErr) throw weaponErr;
    if(!weaponData){ alert("무기를 찾을 수 없습니다."); return; }

    // 직업별 공격/방어
    const jobStats = {
      warrior: { base_atk: 5, base_def: 3 },
      mage: { base_atk: 7, base_def: 1 },
      archer: { base_atk: 6, base_def:2 },
      rogue: { base_atk: 4, base_def:3 },
      paladin: { base_atk: 5, base_def:4 }
    };
    const stats = jobStats[job];

    // 캐릭터 생성 / 저장
    const { data: charData, error: charErr } = await sb.from('characters')
      .insert([{ owner:'player', name, base_atk: stats.base_atk, base_def: stats.base_def, weapon_id: weaponData.id }]);
    if(charErr) throw charErr;

    alert(`캐릭터 생성 완료! 무기: ${weaponData.name} Lv.${weaponData.level}`);
    loadCharacterList();
  }catch(e){
    alert("캐릭터 생성 실패: "+e.message);
  }
};

// 배틀 시작
document.getElementById('startBattleBtn').onclick = async () => {
  const p1 = document.getElementById('player1Id').value.trim();
  const p2 = document.getElementById('player2Id').value.trim();
  if(!p1 || !p2 || p1===p2){ alert("두 캐릭터를 올바르게 입력하세요."); return; }

  try{
    // 캐릭터 정보 불러오기
    const { data: chars, error: charErr } = await sb.from('characters')
      .select('id,name,base_atk,base_def,weapon_id( level, name )')
      .in('id',[p1,p2]);
    if(charErr) throw charErr;
    if(chars.length!==2){ alert("캐릭터 정보가 잘못되었습니다."); return; }

    const [c1, c2] = chars[0].id===p1 ? [chars[0],chars[1]] : [chars[1],chars[0]];

    // 공격력 계산: base_atk + 무기 레벨
    const atk1 = c1.base_atk + c1.weapon_id.level;
    const atk2 = c2.base_atk + c2.weapon_id.level;

    // 방어력 적용
    const final1 = atk1 - c2.base_def;
    const final2 = atk2 - c1.base_def;

    // 승패 결정
    let winner, loser;
    if(final1>final2){ winner=c1; loser=c2; }
    else if(final2>final1){ winner=c2; loser=c1; }
    else { winner=null; loser=null; } // 비김

    // 랜덤 배틀 문구
    const winTexts = [
      "가볍게 공격을 성공했다!",
      "치명타를 날렸다!",
      "강력한 마법으로 승리!",
      "완벽한 전략으로 상대를 제압!"
    ];
    const loseTexts = [
      "방어에 실패했다!",
      "공격을 회피당했다!",
      "마법 방어에 걸렸다!",
      "전략이 빗나갔다!"
    ];
    let battleMsg = "";
    if(winner){
      battleMsg += `${winner.name} 승리!\n`;
      battleMsg += winTexts[Math.floor(Math.random()*winTexts.length)] + "\n";
      battleMsg += `${loser.name} 패배.\n` + loseTexts[Math.floor(Math.random()*loseTexts.length)];
    } else { battleMsg="비겼습니다!"; }

    // 모달 표시
    document.getElementById('battleText').innerText = battleMsg;
    document.getElementById('battleModal').style.display='flex';

    // battles 테이블 기록
    await sb.from('battles').insert([{ player1_id:p1, player2_id:p2, winner_id: winner ? winner.id : null }]);

    // leaderboard 업데이트
    if(winner){
      const { data: lb, error: lbErr } = await sb.from('leaderboard').select('id,wins').eq('player_id',winner.id).single();
      if(lbErr && !lb){ // 없음
        await sb.from('leaderboard').insert([{ player_id: winner.id, wins:1 }]);
      } else if(lb){
        await sb.from('leaderboard').update({ wins: lb.wins+1 }).eq('id',lb.id);
      }
    }

  }catch(e){
    alert("배틀 실패: "+e.message);
  }
};

document.getElementById('closeBattleBtn').onclick = ()=>{ document.getElementById('battleModal').style.display='none'; };

</script>
</body>
</html>

