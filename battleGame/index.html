<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>âš”ï¸ ì „íˆ¬ ê²Œì„</title>
<style>
    body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial,sans-serif; }
    h1 { text-align:center; padding:20px 0; }
    .container { display:flex; flex-direction:column; align-items:center; gap:15px; padding:20px; }
    select, input, button { padding:8px; border-radius:6px; border:none; font-size:14px; margin:5px; }
    button { cursor:pointer; background:#1c1c1c; color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.3); transition:0.2s; }
    button:hover { background:#2a2a2a; }
    #battleResultModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000; }
    #battleResultModal div { background:#1a1a1a; padding:20px; border-radius:12px; width:320px; text-align:center; }
    #leaderboardModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000; }
    #leaderboardModal div { background:#1a1a1a; padding:20px; border-radius:12px; width:320px; text-align:left; max-height:80%; overflow-y:auto; }
</style>
</head>
<body>

<h1>âš”ï¸ ì „íˆ¬ ê²Œì„</h1>

<div class="container">
    <label>ìºë¦­í„° ì„ íƒ</label>
    <select id="characterSelect"></select>

    <label>ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</label>
    <input type="text" id="weaponPassword" placeholder="ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸">

    <label>ìƒëŒ€ ìºë¦­í„° ì„ íƒ</label>
    <select id="opponentSelect"></select>

    <button id="loadWeaponBtn">ë¬´ê¸° ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="battleBtn">ì „íˆ¬ ì‹œì‘</button>
    <button id="leaderboardBtn">ë¦¬ë”ë³´ë“œ ë³´ê¸°</button>
    <button id="goBackBtn">ğŸ  ëŒì•„ê°€ê¸°</button>
</div>

<div id="battleResultModal">
    <div>
        <h3>âš”ï¸ ì „íˆ¬ ê²°ê³¼</h3>
        <div id="battleResultText" style="margin:10px 0;"></div>
        <button id="closeBattleModal">ë‹«ê¸°</button>
    </div>
</div>

<div id="leaderboardModal">
    <div>
        <h3>ğŸ† ë¦¬ë”ë³´ë“œ</h3>
        <div id="leaderboardList" style="margin:10px 0;"></div>
        <button id="closeLeaderboard">ë‹«ê¸°</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentCharacter = null;

// ìºë¦­í„° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadCharacters(){
    const { data, error } = await sb.from('characters').select('id,name').order('created_at',{ascending:true});
    if(error){ console.error(error); alert("ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }
    const select = document.getElementById('characterSelect');
    select.innerHTML = '';
    data.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.name;
        select.appendChild(option);
    });
    // ìƒëŒ€ ì„ íƒì—ë„ ë™ì¼ ëª©ë¡
    const oppSelect = document.getElementById('opponentSelect');
    oppSelect.innerHTML = '';
    data.forEach(c=>{
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.name;
        oppSelect.appendChild(option);
    });
}
loadCharacters();

// ë¬´ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
document.getElementById('loadWeaponBtn').onclick = async () => {
    const charId = document.getElementById('characterSelect').value;
    const password = document.getElementById('weaponPassword').value.trim();
    if(!charId || !password){ alert("ìºë¦­í„°ì™€ ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }

    // ìºë¦­í„° ì •ë³´
    const { data: charData, error: charErr } = await sb.from('characters').select('*').eq('id', charId).single();
    if(charErr || !charData){ alert("ìºë¦­í„° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }

    // ë¬´ê¸° ì •ë³´
    const { data: weaponData, error: weaponErr } = await sb.from('weapons').select('*').eq('password', password).single();
    if(weaponErr || !weaponData){ alert("ë¬´ê¸° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }

    // ìºë¦­í„°ì— ë¬´ê¸° ì ìš©
    const { error: updateErr } = await sb.from('characters').update({
        weapon_id: weaponData.id,
        base_atk: charData.base_atk // ê³µê²©ë ¥ì€ ë ˆë²¨ í•©ì‚°ì€ ë°°í‹€ ì‹œ ê³„ì‚°
    }).eq('id', charId);
    if(updateErr){ alert("ìºë¦­í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"); return; }

    currentCharacter = { ...charData, weapon: weaponData };
    alert(`${charData.name}ì— ${weaponData.name} (Lv.${weaponData.level}) ì ìš© ì™„ë£Œ`);
};

// ì „íˆ¬ ì‹œì‘ ë²„íŠ¼
document.getElementById('battleBtn').onclick = async () => {
    if(!currentCharacter){ alert("ë¨¼ì € ë¬´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”"); return; }
    const player1 = currentCharacter;
    const player2Id = document.getElementById('opponentSelect').value;
    if(player2Id === player1.id){ alert("ìƒëŒ€ ìºë¦­í„°ë¥¼ ë‹¤ë¥¸ ìºë¦­í„°ë¡œ ì„ íƒí•˜ì„¸ìš”"); return; }

    const { data: oppData, error: oppErr } = await sb.from('characters').select('*,weapon_id(*)').eq('id', player2Id).single();
    if(oppErr || !oppData){ alert("ìƒëŒ€ ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }

    // ê³µê²©ë ¥ ê³„ì‚°
    const player1Atk = player1.base_atk + (player1.weapon?.level || 0);
    const player2Atk = oppData.base_atk + (oppData.weapon_id?.level || 0);

    let winner = null;
    if(player1Atk >= player2Atk) winner = player1.id;
    else winner = player2Id;

    // ëœë¤ ì „íˆ¬ ë¬¸êµ¬
    const phrases = [
        "ê°•ë ¥í•œ ì¼ê²©! ğŸ—¡ï¸",
        "ë°©ì–´ë¥¼ ëš«ê³  ê³µê²©! ğŸ’¥",
        "ì¹˜ëª…íƒ€ ë°œìƒ! âš¡",
        "ì‹ ì†í•œ ë°˜ê²©! ğŸ”„",
        "í™”ë ¤í•œ ìŠ¤í‚¬ ì‚¬ìš©! âœ¨"
    ];
    const battleText = `
${player1.name} ê³µê²©ë ¥: ${player1Atk}  
${oppData.name} ê³µê²©ë ¥: ${player2Atk}  
${winner === player1.id ? player1.name : oppData.name} ìŠ¹ë¦¬!  
${phrases[Math.floor(Math.random()*phrases.length)]}
    `;
    document.getElementById('battleResultText').textContent = battleText;
    document.getElementById('battleResultModal').style.display = 'flex';

    // battles ê¸°ë¡
    await sb.from('battles').insert({
        player1_id: player1.id,
        player2_id: player2Id,
        winner_id: winner
    });

    // leaderboard ê°±ì‹ 
    const { data: lbData } = await sb.from('leaderboard').select('*').eq('character_id', winner).single();
    if(lbData){
        await sb.from('leaderboard').update({ wins: lbData.wins + 1 }).eq('character_id', winner);
    } else {
        await sb.from('leaderboard').insert({ character_id: winner, wins: 1 });
    }
};

// ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('closeBattleModal').onclick = () => {
    document.getElementById('battleResultModal').style.display = 'none';
};

// ë¦¬ë”ë³´ë“œ ë³´ê¸°
document.getElementById('leaderboardBtn').onclick = async () => {
    const { data, error } = await sb.from('leaderboard').select('character_id,wins,characters(name)').order('wins',{ascending:false});
    if(error){ alert("ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }
    const listDiv = document.getElementById('leaderboardList');
    listDiv.innerHTML = '';
    data.forEach((row,idx)=>{
        listDiv.innerHTML += `${idx+1}. ${row.characters?.name || 'ì•Œìˆ˜ì—†ìŒ'} - ìŠ¹ë¦¬ ${row.wins}<br>`;
    });
    document.getElementById('leaderboardModal').style.display = 'flex';
});
document.getElementById('closeLeaderboard').onclick = () => {
    document.getElementById('leaderboardModal').style.display = 'none';
};

// ëŒì•„ê°€ê¸°
document.getElementById('goBackBtn').onclick = () => {
    location.href = 'https://kwakkyungmok-del.github.io/my-web-game/';
};
</script>

</body>
</html>
