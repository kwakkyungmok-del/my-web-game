<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>âš”ï¸ ì „íˆ¬ ê²Œì„</title>

<style>
body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial, sans-serif; }
h1 { text-align:center; padding:20px 0; }
.container { max-width:500px; margin:0 auto; padding:20px; display:flex; flex-direction:column; gap:15px; }
label { display:block; margin:10px 0 5px; }
select, input { width:100%; padding:8px; border-radius:6px; border:none; font-size:16px; }
button { padding:10px; border:none; border-radius:6px; cursor:pointer; font-size:16px; margin-top:10px; background:#6366f1; color:#fff; }
button:hover { background:#4f46e5; }
#battleResult { margin-top:15px; line-height:1.4; background:#222; padding:10px; border-radius:8px; min-height:50px; }
</style>
</head>
<body>

<h1>âš”ï¸ ì „íˆ¬ ê²Œì„</h1>

<div class="container">
  <div>
    <label>ë‚´ ìºë¦­í„°:</label>
    <select id="player1Select"></select>
  </div>

  <div>
    <label>ìƒëŒ€ ìºë¦­í„°:</label>
    <select id="player2Select"></select>
  </div>

  <div>
    <label>ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸:</label>
    <input type="text" id="weaponPassword" placeholder="ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
  </div>

  <button id="startBattleBtn">ì „íˆ¬ ì‹œì‘</button>
  <button id="leaderboardBtn">ğŸ† ë¦¬ë”ë³´ë“œ ë³´ê¸°</button>
  <button onclick="window.location.href='https://kwakkyungmok-del.github.io/my-web-game/'">ëŒì•„ê°€ê¸°</button>

  <div id="battleResult"></div>
</div>

<!-- ë¦¬ë”ë³´ë“œ ëª¨ë‹¬ -->
<div id="leaderboardModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center;">
  <div style="background:#1a1a1a; padding:20px; border-radius:12px; width:320px; max-height:80%; overflow-y:auto; box-shadow:0 2px 8px rgba(0,0,0,0.5);">
    <h3>ğŸ† ë¦¬ë”ë³´ë“œ</h3>
    <div id="leaderboardList" style="margin:10px 0;"></div>
    <button id="closeLeaderboardBtn">ë‹«ê¸°</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const player1Select = document.getElementById("player1Select");
const player2Select = document.getElementById("player2Select");
const weaponInput = document.getElementById("weaponPassword");
const battleResult = document.getElementById("battleResult");

async function loadCharacters(){
  try{
    const { data, error } = await sb.from('characters').select('id,name').order('created_at',{ascending:true});
    if(error) throw error;
    player1Select.innerHTML="";
    player2Select.innerHTML="";
    data.forEach(c => {
      const opt1 = document.createElement('option'); opt1.value=c.id; opt1.text=c.name; player1Select.appendChild(opt1);
      const opt2 = document.createElement('option'); opt2.value=c.id; opt2.text=c.name; player2Select.appendChild(opt2);
    });
  }catch(e){ alert("ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:"+e.message); }
}

async function startBattle(){
  battleResult.innerHTML="";
  const player1Id = player1Select.value;
  const player2Id = player2Select.value;
  const password = weaponInput.value.trim();
  if(!player1Id || !player2Id || !password){ battleResult.innerHTML="ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”."; return; }

  try{
    // ë¬´ê¸° ì°¾ê¸°
    const { data:weaponData } = await sb.from('weapons').select('id,name,level').eq('password',password).limit(1);
    if(!weaponData || weaponData.length===0){ battleResult.innerHTML="ë¬´ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; return; }
    const weapon = weaponData[0];

    // ìºë¦­í„° ì •ë³´
    const { data:char1Data } = await sb.from('characters').select('id,name,base_atk,base_def').eq('id',player1Id).limit(1);
    const player1 = char1Data[0];
    const { data:char2Data } = await sb.from('characters').select('id,name,base_atk,base_def').eq('id',player2Id).limit(1);
    const player2 = char2Data[0];

    // ì „íˆ¬ ê³„ì‚°
    const atk1 = player1.base_atk + weapon.level;
    const score1 = atk1 - player2.base_def;
    const score2 = player2.base_atk - player1.base_def;
    const winner = score1>=score2 ? player1 : player2;

    // battles ê¸°ë¡
    await sb.from('battles').insert({ player1_id:player1.id, player2_id:player2.id, winner_id:winner.id });

    // leaderboard ì—…ë°ì´íŠ¸
    const { data:lbData } = await sb.from('leaderboard').select('id,wins').eq('player_id',winner.id).limit(1);
    if(lbData && lbData.length>0){
      await sb.from('leaderboard').update({ wins: lbData[0].wins+1 }).eq('player_id',winner.id);
    }else{
      await sb.from('leaderboard').insert({ player_id:winner.id, wins:1 });
    }

    const msgs = [
      `${player1.name}ì´ ${player2.name}ì—ê²Œ ê°•ë ¥í•œ ê³µê²©!`,
      `${player2.name}ì´ ë°©ì–´í–ˆì§€ë§Œ í”¼í•´ ë°œìƒ!`,
      `${player1.name}ì˜ ìŠ¤í‚¬ ë°œë™!`,
      `${player2.name}ì´ ë°˜ê²©!`
    ];
    const battleMsg = msgs.sort(()=>0.5-Math.random()).slice(0,3).join('<br>');

    battleResult.innerHTML = `<strong>ìŠ¹ë¦¬:</strong> ${winner.name}<br>${battleMsg}`;

  }catch(e){ battleResult.innerHTML="ë°°í‹€ ì‹¤íŒ¨:"+e.message; }
}

// ë¦¬ë”ë³´ë“œ
const leaderboardModal = document.getElementById("leaderboardModal");
const leaderboardList = document.getElementById("leaderboardList");
document.getElementById("leaderboardBtn").onclick = async ()=>{
  leaderboardModal.style.display="flex";
  leaderboardList.innerHTML="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  try{
    const { data } = await sb.from('leaderboard')
      .select('player_id,wins,characters(name)')
      .order('wins',{ascending:false});
    let html="";
    data.forEach(r => {
      html += `${r.characters?.name || "ì•Œ ìˆ˜ ì—†ìŒ"} - ${r.wins}ìŠ¹<br>`;
    });
    leaderboardList.innerHTML=html;
  }catch(e){ leaderboardList.innerHTML="ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:"+e.message; }
};
document.getElementById("closeLeaderboardBtn").onclick = ()=>{ leaderboardModal.style.display="none"; };

loadCharacters();
document.getElementById("startBattleBtn").onclick=startBattle;
</script>

</body>
</html>
