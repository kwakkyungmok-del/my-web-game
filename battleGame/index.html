<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì „íˆ¬ ê²Œì„</title>
<style>
body { margin:0; font-family:Arial, sans-serif; background:#111; color:#fff; display:flex; flex-direction:column; align-items:center; padding:20px; }
h1 { text-align:center; }
input, select, button { padding:8px; margin:5px 0; border-radius:6px; border:none; font-size:16px; }
button { cursor:pointer; background:#0a84ff; color:#fff; transition:0.2s; }
button:hover { background:#006be6; }
.container { max-width:400px; width:100%; }
.card { background:#1c1c1c; padding:20px; border-radius:12px; margin-bottom:20px; }
#battleModal, #leaderboardModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000; }
.modalBox { background:#1a1a1a; padding:20px; border-radius:12px; max-width:90%; width:320px; max-height:80%; overflow-y:auto; text-align:left; }
.modalBox button { width:100%; margin-top:10px; background:#6366f1; color:#fff; }
</style>
</head>
<body>

<h1>âš”ï¸ ì „íˆ¬ ê²Œì„</h1>

<div class="container">
  <div class="card">
    <h2>ìºë¦­í„° ì„ íƒ / ìƒì„±</h2>
    <label>ìºë¦­í„° ì´ë¦„: <input type="text" id="charName" placeholder="ìºë¦­í„° ì´ë¦„"></label><br>
    <label>ì§ì—… ì„ íƒ:
      <select id="jobSelect">
        <option value="warrior">ì „ì‚¬</option>
        <option value="mage">ë§ˆë²•ì‚¬</option>
        <option value="archer">ê¶ìˆ˜</option>
        <option value="rogue">ë„ì </option>
        <option value="paladin">ì„±ê¸°ì‚¬</option>
      </select>
    </label><br>
    <label>ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸: <input type="password" id="weaponPassword" placeholder="ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸"></label><br>
    <button id="loadCharBtn">ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <div class="card">
    <h2>ë°°í‹€ ì‹œì‘</h2>
    <label>ìƒëŒ€ ìºë¦­í„° ID ì…ë ¥: <input type="text" id="enemyId" placeholder="ìƒëŒ€ ìºë¦­í„° id"></label><br>
    <button id="startBattleBtn">ë°°í‹€!</button>
  </div>

  <div class="card">
    <h2>ë¦¬ë”ë³´ë“œ</h2>
    <button id="showLeaderboardBtn">ìŠ¹ë¦¬ ìˆ˜ ìˆœìœ„ ë³´ê¸°</button>
  </div>
</div>

<!-- ë°°í‹€ ê²°ê³¼ ëª¨ë‹¬ -->
<div id="battleModal">
  <div class="modalBox">
    <h3>ğŸ† ë°°í‹€ ê²°ê³¼</h3>
    <div id="battleText"></div>
    <button id="closeBattleBtn">ë‹«ê¸°</button>
  </div>
</div>

<!-- ë¦¬ë”ë³´ë“œ ëª¨ë‹¬ -->
<div id="leaderboardModal">
  <div class="modalBox">
    <h3>ğŸ¥‡ ë¦¬ë”ë³´ë“œ</h3>
    <div id="leaderboardList"></div>
    <button id="closeLeaderboardBtn">ë‹«ê¸°</button>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ì§ì—… ê¸°ë³¸ ê³µê²©ë ¥/ë°©ì–´ë ¥
const JOB_STATS = {
  warrior: { atk: 5, def: 3 },
  mage: { atk: 6, def: 2 },
  archer: { atk: 4, def: 4 },
  rogue: { atk: 5, def: 2 },
  paladin: { atk: 3, def: 5 }
};

let currentChar = null; // ë‚´ ìºë¦­í„°

// ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('loadCharBtn').onclick = async () => {
  const name = document.getElementById('charName').value.trim();
  const job = document.getElementById('jobSelect').value;
  const password = document.getElementById('weaponPassword').value.trim();
  if(!name || !password) { alert("ì´ë¦„ê³¼ ë¬´ê¸° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

  try{
    // ë¬´ê¸° ì¡°íšŒ
    let { data: weapons, error:wErr } = await sb.from('weapons')
      .select('*')
      .eq('password', password)
      .limit(1);
    if(wErr) throw wErr;
    if(!weapons || weapons.length===0){ alert("ë¹„ë°€ë²ˆí˜¸ì— ë§ëŠ” ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
    const weapon = weapons[0];

    // ìºë¦­í„° ì¡°íšŒ (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¶ˆëŸ¬ì˜¤ê¸°)
    let { data: chars, error:cErr } = await sb.from('characters')
      .select('*')
      .eq('name', name)
      .eq('owner', weapon.owner)
      .limit(1);
    if(cErr) throw cErr;

    if(chars && chars.length>0){
      currentChar = chars[0];
      alert(`ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ë¬´ê¸°: ${weapon.name}, ê³µê²©ë ¥/ë°©ì–´ë ¥ ì ìš©ë¨`);
    }else{
      // ìƒˆ ìºë¦­í„° ìƒì„±
      const baseAtk = JOB_STATS[job].atk + weapon.level;
      const baseDef = JOB_STATS[job].def;
      const { data:newChar, error:nErr } = await sb.from('characters').insert([{
        owner: weapon.owner,
        name: name,
        base_atk: baseAtk,
        base_def: baseDef,
        weapon_id: weapon.id
      }]).select().single();
      if(nErr) throw nErr;
      currentChar = newChar;
      alert(`ìºë¦­í„° ìƒì„± ì™„ë£Œ! ë¬´ê¸°: ${weapon.name}, ê³µê²©ë ¥:${baseAtk}, ë°©ì–´ë ¥:${baseDef}`);
    }
  } catch(e){ alert("ìºë¦­í„° ë¡œë”© ì‹¤íŒ¨: "+e.message); }
};

// ë°°í‹€ ì‹œì‘
document.getElementById('startBattleBtn').onclick = async () => {
  if(!currentChar){ alert("ë¨¼ì € ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”."); return; }
  const enemyId = document.getElementById('enemyId').value.trim();
  if(!enemyId){ alert("ìƒëŒ€ ìºë¦­í„° id ì…ë ¥í•˜ì„¸ìš”."); return; }

  try{
    let { data: enemyArr, error:eErr } = await sb.from('characters').select('*').eq('id', enemyId).limit(1);
    if(eErr) throw eErr;
    if(!enemyArr || enemyArr.length===0){ alert("ìƒëŒ€ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
    const enemy = enemyArr[0];

    // ë¬´ê¸° ì¡°íšŒ
    let { data: myWeaponArr } = await sb.from('weapons').select('*').eq('id', currentChar.weapon_id).limit(1);
    let { data: enemyWeaponArr } = await sb.from('weapons').select('*').eq('id', enemy.weapon_id).limit(1);
    const myWeapon = myWeaponArr[0];
    const enemyWeapon = enemyWeaponArr[0];

    const myAtk = currentChar.base_atk + myWeapon.level;
    const myDef = currentChar.base_def;
    const enemyAtk = enemy.base_atk + enemyWeapon.level;
    const enemyDef = enemy.base_def;

    const myScore = myAtk - enemyDef;
    const enemyScore = enemyAtk - myDef;

    let winner = null;
    if(myScore > enemyScore) winner = currentChar;
    else if(myScore < enemyScore) winner = enemy;
    else winner = Math.random()<0.5 ? currentChar : enemy;

    // ëœë¤ ë°°í‹€ ë¬¸êµ¬
    const events = [
      "ê°•ë ¥í•œ ì¼ê²©!",
      "ì¹˜ëª…ì ì¸ ë§ˆë²• ê³µê²©!",
      "í™”ì‚´ì´ ë¹—ë‚˜ê°”ì§€ë§Œ ì¬ë¹ ë¥¸ ê³µê²©!",
      "ë°©íŒ¨ë¡œ ë§‰ì•„ëƒˆë‹¤!",
      "ì¹˜ëª…íƒ€ ë°œìƒ!"
    ];
    const battleText = `
${currentChar.name}(${myWeapon.name}) ê³µê²©:${myAtk} ë°©ì–´:${myDef}
vs
${enemy.name}(${enemyWeapon.name}) ê³µê²©:${enemyAtk} ë°©ì–´:${enemyDef}
-------------------
ê²°ê³¼: ${winner.name} ìŠ¹ë¦¬!
-------------------
ì „íˆ¬ ì´ë²¤íŠ¸:
- ${events[Math.floor(Math.random()*events.length)]}
- ${events[Math.floor(Math.random()*events.length)]}
- ${events[Math.floor(Math.random()*events.length)]}
    `;
    document.getElementById('battleText').innerHTML = battleText;
    document.getElementById('battleModal').style.display='flex';

    // battles í…Œì´ë¸” ê¸°ë¡
    const { data:battleRec, error:bErr } = await sb.from('battles').insert([{
      player1_id: currentChar.id,
      player2_id: enemy.id,
      winner_id: winner.id
    }]);
    if(bErr) console.log("ë°°í‹€ ê¸°ë¡ ì˜¤ë¥˜:",bErr);

    // leaderboard ê°±ì‹ 
    const { data: lbData, error:lbErr } = await sb.from('leaderboard').select('*').eq('player_id', winner.id).limit(1);
    if(lbErr) console.log(lbErr);
    if(lbData && lbData.length>0){
      await sb.from('leaderboard').update({ wins: lbData[0].wins + 1 }).eq('player_id', winner.id);
    }else{
      await sb.from('leaderboard').insert([{ player_id: winner.id, wins:1 }]);
    }

  } catch(e){ alert("ë°°í‹€ ì‹¤íŒ¨: "+e.message); }
};

document.getElementById('closeBattleBtn').onclick = () => { document.getElementById('battleModal').style.display='none'; };

// ë¦¬ë”ë³´ë“œ ë³´ê¸°
document.getElementById('showLeaderboardBtn').onclick = async () => {
  try{
    let { data: lb, error:lbErr } = await sb.from('leaderboard').select('player_id, wins, characters(name)').order('wins',{ascending:false}).limit(10).leftJoin('characters','characters.id','player_id');
    if(lbErr) throw lbErr;
    if(!lb || lb.length===0){ alert("ìŠ¹ë¦¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    let html = "";
    lb.forEach((rec,idx)=>{ html += `${idx+1}. ${rec.characters?.name || rec.player_id} - ${rec.wins}ìŠ¹<br>`; });
    document.getElementById('leaderboardList').innerHTML = html;
    document.getElementById('leaderboardModal').style.display='flex';
  }catch(e){ alert("ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:"+e.message); }
};
document.getElementById('closeLeaderboardBtn').onclick = ()=>{ document.getElementById('leaderboardModal').style.display='none'; };
</script>

</body>
</html>
