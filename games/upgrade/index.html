<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë¬´ê¸° ê°•í™” ì‹œë®¬ë ˆì´í„°</title>
<style>
body { margin:0; padding:0; background:#111; color:#fff; font-family:Arial; display:flex; justify-content:center; align-items:center; height:100vh; }
#backBtn { position:fixed; top:10px; left:10px; padding:8px 12px; background:#333; color:#fff; border:none; border-radius:6px; cursor:pointer; }
.box { width:320px; background:#1a1a1a; padding:20px; border-radius:12px; text-align:center; transition: transform 0.1s, background 0.1s; }
button { width:100%; padding:10px; margin:6px 0; border:none; border-radius:8px; font-size:14px; cursor:pointer;}
#upgradeBtn { background:#3b82f6; color:white; }
#sellBtn { background:#f59e0b; color:black; }
#attendanceBtn { background:#16a34a; color:white; }
#rescueBtn { background:#dc2626; color:white; }
#gold { color:#facc15; margin:6px 0; font-weight:bold; }
#rate { color:#60a5fa; margin:4px 0; font-size:13px; }
#log { min-height:24px; margin:10px 0; color:#facc15; }
#artisanMsg { margin-bottom:10px; color:#34d399; font-weight:bold; }
.collection { max-height:120px; overflow-y:auto; background:#0f0f0f; padding:6px; border-radius:6px; font-size:12px; margin-top:10px; text-align:left; }
.item { background:#222; margin-bottom:4px; padding:4px; border-radius:4px; }

/* ê¸°ë¡ ë“±ë¡ ëª¨ë‹¬ */
#recordModal {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999;
}
#recordModal .modalBox {
    background:#1a1a1a; padding:20px; border-radius:12px; width:280px; text-align:center;
}
#recordModal input {
    width:100%; padding:8px; margin:10px 0; border:none; border-radius:6px;
}
#recordModal .saveBtn { background:#f59e0b; color:black; }
#recordModal .closeBtn { background:#333; color:white; }
</style>
</head>
<body>

<button id="backBtn">â† ë’¤ë¡œê°€ê¸°</button>

<div class="box">
    <div id="artisanMsg">ì¬ë¯¼ì´ ì¸ì‚¬ë¥¼ ê±´ë„µë‹ˆë‹¤â€¦</div>
    <h2 id="weaponName">ë‚¡ì€ ê²€</h2>
    <div id="weaponIcon" style="font-size:48px; margin:6px 0;">ğŸ—¡ï¸</div>
    <div id="weaponLevel">+0</div>
    <div id="rate">ì„±ê³µ í™•ë¥ : 100%</div>
    <div id="gold">ğŸ’° 0 G</div>

    <button id="upgradeBtn">ê°•í™”í•˜ê¸° (20G)</button>
    <button id="sellBtn">ë¬´ê¸° íŒë§¤</button>
    <button id="attendanceBtn">ì¶œì„ ì²´í¬</button>
    <button id="rescueBtn">ê¸´ê¸‰ ì§€ì› ë°›ê¸°</button>
    <button id="openRecordBtn" style="background:#6366f1; color:white;">ê²€ ê¸°ë¡ ë“±ë¡</button>

    <div id="log">ê°•í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>

    <div class="collection" id="collection"></div>
</div>

<div id="recordModal">
    <div class="modalBox">
        <h3>ê²€ ê¸°ë¡ ë“±ë¡</h3>
        <input type="text" id="recordName" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
        <button class="saveBtn" id="saveRecordBtn">ë“±ë¡</button>
        <button class="closeBtn" id="closeRecordBtn">ë‹«ê¸°</button>
    </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ------------------------- ë°ì´í„° ------------------------- */
let level = 0;
let gold = 0;
const upgradeCost = 20;

const stageNames = ["ë‚¡ì€","ë‹¨ë‹¨í•œ","ê°•ì² ","ë¶ˆíƒ€ëŠ”","ìš©ì˜"];
const extras = ["ë‚ ì¹´ë¡œìš´","ë¬µì§í•œ","ë¹›ë‚˜ëŠ”","ì €ì£¼ë°›ì€","ì‹ ì„±í•œ","ê´‘í­í•œ"];
const artisanGreetings = [
    "ì¢‹ì€ í•˜ë£¨ì…ë‹ˆë‹¤! ê²€ ê°•í™” ì¤€ë¹„ëë‚˜ìš”?",
    "ê°•í™”ë¥¼ ì¦ê¸°ëŸ¬ ì™”êµ°ìš”!",
    "ì˜¤ëŠ˜ë„ ê°•ì² ê°™ì´ ë‹¨ë‹¨í•´ì ¸ ë´…ì‹œë‹¤!",
    "ë¬´ê¸° ê´€ë¦¬ë„ ì¤‘ìš”í•˜ì£ , ì¡°ì‹¬í•˜ì„¸ìš”!",
    "í˜ë‚´ì„¸ìš”! í–‰ìš´ì´ í•¨ê»˜í•˜ê¸¸!",
    "ê°•í™”ëŠ” ë§ˆìŒê°€ì§ë¶€í„° ì‹œì‘ì…ë‹ˆë‹¤."
];

let collectionSet = new Set(JSON.parse(localStorage.getItem("collection") || "[]"));

if(!localStorage.getItem("initGold")){
    gold = 1000;
    localStorage.setItem("initGold","true");
    localStorage.setItem("gold",gold);
}else{
    gold = parseInt(localStorage.getItem("gold") || "0");
}

/* ------------------------- ìœ í‹¸ ------------------------- */
function showRandomGreeting(){
    const msg = artisanGreetings[Math.floor(Math.random()*artisanGreetings.length)];
    document.getElementById("artisanMsg").innerText = `ì¬ë¯¼: "${msg}"`;
}

function getWeaponName(){
    const stage = stageNames[Math.min(Math.floor(level/5), stageNames.length-1)];
    const extra = extras[level%extras.length];
    return level===0?`${stage} ê²€`:`${stage} ${extra} ê²€`;
}

function getWeaponIcon(){
    if(level<5) return "ğŸ—¡ï¸";
    if(level<10) return "âš”ï¸";
    if(level<15) return "ğŸ”¥âš”ï¸";
    return "ğŸ‘‘âš”ï¸";
}

function getSuccessRate(){
    if(level===0) return 100;
    let rate = 100;
    for(let i=1;i<=level;i++){
        if(i<=5) rate-=(6-i); else rate-=2;
    }
    return Math.max(rate,5);
}

function log(msg){ document.getElementById("log").innerText = msg; }
function updateGold(){ document.getElementById("gold").innerText = `ğŸ’° ${gold} G`; localStorage.setItem("gold",gold); }
function addToCollection(name){
    if(collectionSet.has(name)) return;
    collectionSet.add(name);
    localStorage.setItem("collection",JSON.stringify([...collectionSet]));
    const div = document.createElement("div"); div.className="item"; div.innerText=name;
    document.getElementById("collection").appendChild(div);
}
function loadCollection(){
    const saved = JSON.parse(localStorage.getItem("collection") || "[]");
    const box = document.getElementById("collection");
    box.innerHTML = "";
    saved.forEach(name=>{ const div=document.createElement("div"); div.className="item"; div.innerText=name; box.appendChild(div); collectionSet.add(name); });
}

/* ------------------------- í•µì‹¬ ê¸°ëŠ¥ ------------------------- */
function updateWeapon(){
    const name = getWeaponName();
    document.getElementById("weaponName").innerText = name;
    document.getElementById("weaponLevel").innerText = "+"+level;
    document.getElementById("rate").innerText = `ì„±ê³µ í™•ë¥ : ${getSuccessRate()}%`;
    document.getElementById("weaponIcon").innerText = getWeaponIcon();
    addToCollection(name);
}

function upgrade(){
    if(gold<upgradeCost){ log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
    gold-=upgradeCost; updateGold();
    const rate = getSuccessRate();
    const rand = Math.random()*100;
    const box = document.querySelector('.box');
    if(rand<=rate){ level++; log("ê°•í™” ì„±ê³µ! +1"); showRandomGreeting();
        box.style.transform="scale(1.05)"; box.style.background="#2a2a2a";
        setTimeout(()=>{ box.style.transform="scale(1)"; box.style.background="#1a1a1a"; },100);
    }else{ if(Math.random()<0.05){ log("ğŸ’¥ ë¬´ê¸° íŒŒê´´! ìƒˆ ë¬´ê¸° ì§€ê¸‰"); resetWeapon(); } else { log("ê°•í™” ì‹¤íŒ¨â€¦ ë³€í™” ì—†ìŒ"); } }
    updateWeapon();
}

function resetWeapon(){ level=0; updateWeapon(); }

function sellWeapon(){
    if(level===0){ log("ê¸°ë³¸ ë¬´ê¸°ëŠ” íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    const price = level*30; gold+=price; updateGold(); log(`+${level} ë¬´ê¸°ë¥¼ ${price}Gì— íŒë§¤í–ˆìŠµë‹ˆë‹¤.`); resetWeapon();
}

function checkAttendance(){
    const today = new Date().toDateString();
    if(localStorage.getItem("attendance")===today){ log("ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆìŠµë‹ˆë‹¤."); return; }
    gold+=100; updateGold(); localStorage.setItem("attendance",today); log("ì¶œì„ ë³´ìƒ 100G ì§€ê¸‰!");
}

function emergencyRescue(){
    if(localStorage.getItem("emergencyUsed")==="true"){ log("ì´ë¯¸ ê¸´ê¸‰ ì§€ì›ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤."); return; }
    const reward=500; gold+=reward; updateGold(); localStorage.setItem("emergencyUsed","true"); log(`ğŸ†˜ ì‹œìŠ¤í…œ ë³µêµ¬ ë³´ìƒ ${reward}G ì§€ê¸‰!`);
    checkEmergencyButton();
}

function checkEmergencyButton(){ document.getElementById("rescueBtn").style.display=(localStorage.getItem("emergencyUsed")==="true")?"none":"block"; }

function goBack(){ window.location.href="https://kwakkyungmok-del.github.io/my-web-game/"; }

/* ------------------------- ê¸°ë¡ ë“±ë¡ Supabase ------------------------- */
document.getElementById("openRecordBtn").onclick = ()=>{ document.getElementById("recordModal").style.display="flex"; };
document.getElementById("closeRecordBtn").onclick = ()=>{ document.getElementById("recordModal").style.display="none"; };
document.getElementById("saveRecordBtn").onclick = async ()=>{
    const name = document.getElementById("recordName").value.trim();
    if(name===""){ alert("ë‹‰ë„¤ì„ ì…ë ¥í•´ë¼"); return; }
    const { data, error } = await sb.from('swordRankings').insert([{ owner:name, weapon:getWeaponName(), level:level }]);
    if(error){ alert("ë“±ë¡ ì‹¤íŒ¨:"+error.message); return; }
    alert("ë“±ë¡ ì™„ë£Œ!"); document.getElementById("recordModal").style.display="none"; document.getElementById("recordName").value="";
};

/* ------------------------- ë²„íŠ¼ ì—°ê²° ------------------------- */
document.getElementById("upgradeBtn").addEventListener("click",upgrade);
document.getElementById("sellBtn").addEventListener("click",sellWeapon);
document.getElementById("attendanceBtn").addEventListener("click",checkAttendance);
document.getElementById("rescueBtn").addEventListener("click",emergencyRescue);
document.getElementById("backBtn").addEventListener("click",goBack);

/* ------------------------- ìµœì´ˆ ì‹¤í–‰ ------------------------- */
showRandomGreeting(); updateWeapon(); updateGold(); checkEmergencyButton(); loadCollection();
</script>
</body>
</html>
