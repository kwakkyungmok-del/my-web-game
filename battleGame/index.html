<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>âš”ï¸ ì „íˆ¬ ê²Œì„</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#0f0f0f; color:#fff; padding:20px; }
h1 { text-align:center; }
.card, #createCharacterDiv, #characterList, #leaderboardList { background:#1c1c1c; border-radius:12px; padding:15px; margin-bottom:15px; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
#backBtn { background:#0a84ff; color:#fff; position:fixed; top:20px; right:20px; }
#backBtn:hover { background:#006be6; }
</style>
</head>
<body>

<h1>âš”ï¸ ì „íˆ¬ ê²Œì„</h1>

<!-- ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
<button id="backBtn">ğŸ  ëŒì•„ê°€ê¸°</button>

<!-- ìºë¦­í„° ìƒì„± UI -->
<div id="createCharacterDiv">
  <h3>ğŸ›¡ï¸ ìºë¦­í„° ìƒì„±</h3>
  <input type="text" id="newCharName" placeholder="ìºë¦­í„° ì´ë¦„" style="padding:5px; border-radius:5px; border:none; margin-right:10px;">
  <select id="newCharJob" style="padding:5px; border-radius:5px; border:none; margin-right:10px;">
    <option value="warrior">ì „ì‚¬</option>
    <option value="mage">ë§ˆë²•ì‚¬</option>
    <option value="archer">ê¶ìˆ˜</option>
    <option value="thief">ë„ì </option>
    <option value="paladin">ì„±ê¸°ì‚¬</option>
  </select>
  <button id="createCharBtn">ìƒì„±</button>
</div>

<!-- ìºë¦­í„° ëª©ë¡ -->
<div id="characterList">ìºë¦­í„° ëª©ë¡ ë¡œë”© ì¤‘...</div>

<!-- ë°°í‹€ UI -->
<div class="card">
  <h3>âš”ï¸ ë°°í‹€</h3>
  <label>í”Œë ˆì´ì–´ 1(ë‹¹ì‹ ): </label>
  <select id="player1Select"></select><br><br>
  <label>í”Œë ˆì´ì–´ 2: </label>
  <select id="player2Select"></select><br><br>
  <button id="battleBtn">ë°°í‹€ ì‹œì‘</button>
</div>

<!-- ë°°í‹€ ê²°ê³¼ ëª¨ë‹¬ -->
<div id="battleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center;">
  <div style="background:#1a1a1a; padding:20px; border-radius:12px; width:320px; text-align:center;">
    <h3>âš”ï¸ ë°°í‹€ ê²°ê³¼</h3>
    <div id="battleResult" style="margin:10px 0;"></div>
    <button id="closeBattleModal">ë‹«ê¸°</button>
  </div>
</div>

<!-- ë¦¬ë”ë³´ë“œ -->
<div id="leaderboardList">ë¦¬ë”ë³´ë“œ ë¡œë”© ì¤‘...</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lpgcfyisclihwlvlxent.supabase.co";
const SUPABASE_KEY = "sb_publishable_ftA0tc3gS_v48aDVFFpF3g_velgD4y9";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const auth = { user: () => ({ id: "demo-user" }) }; // í…ŒìŠ¤íŠ¸ìš©, ì‹¤ì œ auth ì‚¬ìš© ì‹œ ë°”ê¿”ì£¼ì„¸ìš”

// ëŒì•„ê°€ê¸° ë²„íŠ¼
document.getElementById('backBtn').onclick = () => {
  location.href = "https://kwakkyungmok-del.github.io/my-web-game/";
};

// ìºë¦­í„° ìƒì„±
document.getElementById('createCharBtn').onclick = async () => {
  const name = document.getElementById('newCharName').value.trim();
  const job = document.getElementById('newCharJob').value;
  if(!name) return alert("ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const jobs = {
    warrior: { base_atk: 5, base_def: 3 },
    mage: { base_atk: 7, base_def: 1 },
    archer: { base_atk: 6, base_def: 2 },
    thief: { base_atk: 4, base_def: 4 },
    paladin: { base_atk: 5, base_def: 5 }
  };

  try {
    const { data, error } = await sb.from('characters').insert([{
      owner: auth.user()?.id,
      name: name,
      base_atk: jobs[job].base_atk,
      base_def: jobs[job].base_def,
      weapon_id: null
    }]);
    if(error) throw error;
    alert("ìºë¦­í„°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
    document.getElementById('newCharName').value = "";
    refreshCharacterList();
  } catch(e) {
    alert("ìºë¦­í„° ìƒì„± ì‹¤íŒ¨: " + e.message);
  }
};

// ìºë¦­í„° ëª©ë¡ ê°±ì‹ 
async function refreshCharacterList() {
  try {
    const { data, error } = await sb.from('characters')
      .select('id,name')
      .order('created_at', { ascending:true });
    if(error) throw error;

    const listDiv = document.getElementById('characterList');
    listDiv.innerHTML = "";
    const player1Select = document.getElementById('player1Select');
    const player2Select = document.getElementById('player2Select');
    player1Select.innerHTML = "";
    player2Select.innerHTML = "";

    if(data && data.length>0){
      data.forEach(c=>{
        const div = document.createElement('div');
        div.textContent = `${c.name} (${c.id})`;
        listDiv.appendChild(div);

        const option1 = document.createElement('option');
        option1.value = c.id;
        option1.textContent = c.name;
        player1Select.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = c.id;
        option2.textContent = c.name;
        player2Select.appendChild(option2);
      });
      // í”Œë ˆì´ì–´1 ìë™ ì„ íƒ (ì²«ë²ˆì§¸ ìºë¦­í„°)
      player1Select.value = data[0].id;
    } else {
      listDiv.textContent = "ìƒì„±ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    }
  } catch(e){
    alert("ìºë¦­í„° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: "+e.message);
  }
}

// ë°°í‹€
document.getElementById('battleBtn').onclick = async () => {
  const p1 = document.getElementById('player1Select').value;
  const p2 = document.getElementById('player2Select').value;
  if(p1===p2) return alert("í”Œë ˆì´ì–´ 1ê³¼ 2ëŠ” ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.");

  try {
    const { data: chars, error: charError } = await sb.from('characters')
      .select('id,name,base_atk,base_def,weapon_id')
      .in('id',[p1,p2]);
    if(charError) throw charError;
    if(!chars || chars.length!==2) return alert("ìºë¦­í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

    const p1c = chars.find(c=>c.id===p1);
    const p2c = chars.find(c=>c.id===p2);

    // ê³µê²©ë ¥ ê³„ì‚°
    const p1Atk = p1c.base_atk + (p1c.weapon_id?.level||0);
    const p2Atk = p2c.base_atk + (p2c.weapon_id?.level||0);

    // ë°©ì–´ë ¥ ì ìš©
    const p1Def = p1c.base_def;
    const p2Def = p2c.base_def;
    const score1 = p1Atk - p2Def;
    const score2 = p2Atk - p1Def;

    let winnerId, resultText;
    if(score1>score2){ winnerId=p1; resultText=`${p1c.name} ìŠ¹ë¦¬!`; }
    else if(score2>score1){ winnerId=p2; resultText=`${p2c.name} ìŠ¹ë¦¬!`; }
    else { winnerId=null; resultText="ë¬´ìŠ¹ë¶€!"; }

    // ëœë¤ ë°°í‹€ ë¬¸êµ¬
    const actions = ["ê°•ë ¥í•˜ê²Œ ê³µê²©í–ˆë‹¤!", "ë°©ì–´ì— ì„±ê³µí–ˆë‹¤!", "ì¹˜ëª…íƒ€ê°€ í„°ì¡Œë‹¤!", "ë¬´ê¸° ê¸°ìˆ ì„ ì‚¬ìš©í–ˆë‹¤!"];
    const actionText = actions[Math.floor(Math.random()*actions.length)];
    document.getElementById('battleResult').innerHTML = resultText + "<br>" + actionText;
    document.getElementById('battleModal').style.display="flex";

    // battles í…Œì´ë¸” ê¸°ë¡
    await sb.from('battles').insert([{
      player1_id:p1,
      player2_id:p2,
      winner_id:winnerId,
      created_at:new Date()
    }]);

    // leaderboard ê°±ì‹ 
    if(winnerId){
      const { data: lbData, error: lbError } = await sb.from('leaderboard')
        .select('*')
        .eq('character_id',winnerId);
      if(lbError) throw lbError;

      if(lbData && lbData.length>0){
        await sb.from('leaderboard')
          .update({ wins: lbData[0].wins+1, updated_at: new Date() })
          .eq('character_id', winnerId);
      } else {
        await sb.from('leaderboard').insert([{ character_id:winnerId, wins:1, updated_at: new Date() }]);
      }
    }

    refreshLeaderboard();
  } catch(e){
    alert("ë°°í‹€ ì‹¤íŒ¨: "+e.message);
  }
};

// ë°°í‹€ ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('closeBattleModal').onclick = ()=>{ document.getElementById('battleModal').style.display="none"; };

// ë¦¬ë”ë³´ë“œ ì•ˆì „ ê°±ì‹ 
async function refreshLeaderboard(){
  try{
    const { data, error } = await sb.from('leaderboard')
      .select('character_id,wins')
      .order('wins',{ascending:false});
    if(error) throw error;
    const lbDiv = document.getElementById('leaderboardList');
    lbDiv.innerHTML = "";
    if(data && data.length>0){
      data.forEach((entry,idx)=>{
        lbDiv.innerHTML += `${idx+1}. ${entry.character_id} - ìŠ¹ë¦¬: ${entry.wins}<br>`;
      });
    } else {
      lbDiv.textContent="ë¦¬ë”ë³´ë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.";
    }
  } catch(e){
    alert("ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: "+e.message);
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ
document.addEventListener('DOMContentLoaded',()=>{
  refreshCharacterList();
  refreshLeaderboard();
});
</script>

</body>
</html>

